<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<title>UNDRA ‚Äì Heldenbrief</title>

<!-- CSS: f√ºge den kompletten CSS‚ÄëBlock direkt nach diesem Kommentar ein -->

<style>
/* ===== SEITE 3 ‚Äì LAYOUT ===== */

#step-3 {
    padding: 10px;
}

/* Zeilen-Panel */
.s3-panel {
    border: 1px solid gold;
    margin: 8px 10px;
    border-radius: 6px;
    background: rgba(0,0,0,.35);
    padding: 8px 10px;
}

/* Kopfzeile Seite 3 */
.s3-header-title {
    font-size: 18px;
    color: #f3e3a2;
    text-align: center;
    margin: 0;
    text-shadow: 0 0 6px rgba(255,215,0,0.5);
}

/* Zeile 2: Merkmale / Portrait / SP */
.s3-row-flex {
    display: flex;
    gap: 10px;
    align-items: stretch;
}

.s3-col {
    flex: 1;
}

.s3-col-fixed {
    width: 180px;
}

/* Merkmalsblock */
.s3-hero-summary {
    border: 1px solid gold;
    padding: 6px;
    border-radius: 6px;
    font-size: 13px;
}

/* SP Anzeige */
.s3-sp-box {
    border: 1px solid gold;
    border-radius: 6px;
    padding: 6px;
    text-align: center;
    margin-top: 8px;
    font-size: 13px;
}

.s3-sp-value {
    color: #ffe7a8;
    font-weight: bold;
    text-shadow: 0 0 6px rgba(255,215,0,0.5);
}

/* Attribute (Zeile 3) ‚Äì Raster einfach gehalten */
.s3-attr-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px 12px;
    font-size: 12px;
}

.s3-attr-row {
    display: grid;
    grid-template-columns: 1.2fr 24px 26px;
    gap: 4px;
    align-items: center;
}

.s3-attr-name {
    white-space: nowrap;
}

.s3-attr-value {
    border: 1px solid gold;
    text-align: center;
    padding: 2px;
    font-size: 11px;
}

.s3-attr-arrow {
    opacity: 0;
    cursor: default;
    transition: 0.2s ease;
    font-size: 16px;
    text-align: center;
    color: gold;
    text-shadow: 0 0 6px rgba(255,215,0,0.7);
}

.s3-attr-arrow.active {
    opacity: 1;
    cursor: pointer;
}

/* Zeile 4: Vitalwerte */
.s3-vital-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 20px;
    font-size: 13px;
}

.s3-vital-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
}









.s3-vital-btn {
    padding: 2px 8px;
    font-size: 11px;
    border-radius: 10px;
    border: 1px solid gold;
    background: #130707;
    color: gold;
    cursor: pointer;
}

.s3-vital-btn[disabled] {
    opacity: 0.4;
    cursor: not-allowed;
}

/* Zeile 5: Kampfblock */
.s3-combat-layout {
    display: grid;
    grid-template-columns: 1.2fr 1fr;
    gap: 10px;
}

.s3-combat-grid {
    display: grid;
    grid-template-columns: 1fr 40px;
    gap: 4px 8px;
    font-size: 12px;
}

.s3-txtarea {
    width: 100%;
    min-height: 60px;
    resize: vertical;
    background: #050306;
    color: #eaddca;
    border: 1px solid #444;
    border-radius: 4px;
    font-family: Georgia, serif;
    font-size: 12px;
    padding: 4px;
}

.s3-hitzones-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px;
    font-size: 11px;
    text-align: center;
}

.s3-hitzone-cell {
    border: 1px solid #444;
    padding: 2px;
    border-radius: 4px;
}

.s3-diagram-box,
.s3-figure-box,
.s3-orb-box {
    border: 1px solid #333;
    border-radius: 6px;
    background: #050306;
    text-align: center;
    padding: 6px;
    font-size: 11px;
    color: #aaa;
}

/* Zeile 6: F√§higkeiten */
.s3-skill-section-title {
    font-size: 14px;
    color: #ffe7a8;
    margin-bottom: 4px;
}

.s3-skill-grid {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 4px 8px;
    font-size: 11px;
}

.s3-skill-row {
    border: 1px solid #333;
    border-radius: 4px;
    padding: 3px 4px;
    display: grid;
    grid-template-columns: 1.2fr 30px 46px;
    gap: 2px;
    align-items: center;
}

.s3-skill-name {
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
}

.s3-skill-level {
    text-align: center;
}

.s3-skill-btn {
    font-size: 10px;
    padding: 2px 4px;
    border-radius: 8px;
    border: 1px solid gold;
    background: #160909;
    color: gold;
    cursor: pointer;
}

.s3-skill-btn[disabled] {
    opacity: 0.35;
    cursor: not-allowed;
}

/* Zeile 7: Inventar (einfaches Grid) */
.s3-inventory-grid {
    display: grid;
    grid-template-columns: repeat(8, 1fr);
    gap: 4px;
    font-size: 10px;
}

.s3-inventory-slot {
    border: 1px solid #333;
    border-radius: 4px;
    height: 32px;
    background: #050306;
}

/* Zeile 8: Prozentanzeige */
.s3-percent-grid {
    display: grid;
    grid-template-columns: repeat(4, 1fr);
    gap: 6px;
    font-size: 11px;
}

.s3-percent-row {
    display: flex;
    flex-direction: column;
    gap: 2px;
}

.s3-progress-bar {
    width: 100%;
    height: 6px;
    background: #222;
    border-radius: 4px;
    overflow: hidden;
}

.s3-progress-fill {
    height: 100%;
    background: linear-gradient(90deg,#7a121b,#f3e3a2);
}

/* Zeile 9: Timeline */
.s3-timeline-grid {
    display: grid;
    grid-template-columns: repeat(30, 1fr);
    gap: 2px;
    font-size: 9px;
}

.s3-day-btn {
    padding: 3px 0;
    border-radius: 4px;
    border: 1px solid #444;
    text-align: center;
    cursor: default;
    background: #050306;
    color: #aaa;
}

.s3-day-btn.active {
    border-color: gold;
    color: #ffe7a8;
    box-shadow: 0 0 6px rgba(255,215,0,0.4);
}

.s3-day-btn.checked {
    background: linear-gradient(135deg,#004400,#001a00);
    border-color: #00aa44;
    color: #88ff88;
    box-shadow:
        0 0 8px rgba(0,255,120,0.5),
        inset 0 0 6px rgba(0,255,120,0.4);
}







/* ============================
GLOBAL
============================ */
/* ============================
GLOBAL ‚Äì UNDRA BLOODCORE R2
============================ */
body {
    background: #050307;
    color: #f5f1ff;
    font-family: "Georgia", serif;

    margin: 0;
    padding: 20px 0;
    box-sizing: border-box;

    background-image:
        radial-gradient(circle at 20% 20%, rgba(255, 60, 60, 0.08), transparent 60%),
        radial-gradient(circle at 80% 80%, rgba(255, 200, 80, 0.06), transparent 60%);
}

/* ============================
ANMERKUNG ‚Äì BOX (Bloodcore R2)
============================ */
#anmerkungBlock {
    width: 450px;
    max-width: 100%;
    margin: 30px auto 0 auto;

    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;

    border-radius: 6px;
    padding: 16px 18px;

    display: flex;
    flex-direction: column;
    gap: 10px;

    box-shadow:
        0 0 28px rgba(0,0,0,1),
        0 0 26px rgba(255, 60, 60, 0.55),
        0 0 18px rgba(255, 200, 80, 0.45),
        inset 0 0 18px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);
}
/* ============================
ANMERKUNG ‚Äì TITEL (Bloodcore R2)
============================ */
.anmerkung-title {
    font-size: 18px;
    font-weight: bold;
    color: #ffe9b4;

    letter-spacing: 0.6px;
    padding-bottom: 6px;
    margin-bottom: 10px;

    border-bottom: 1px solid rgba(255, 210, 120, 0.6);

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 10px rgba(255, 60, 60, 0.4);
}

/* ============================
ANMERKUNG ‚Äì TEXTFELD (Bloodcore R2)
============================ */
#anmerkungText {
    width: 100%;
    height: 140px;

    background: rgba(10, 4, 6, 0.92);
    border: 2px solid #603020;
    border-radius: 4px;

    color: #fff8e8;
    padding: 10px;
    resize: none;

    font-family: "Georgia", serif;
    font-size: 14px;
    line-height: 1.4;

    box-shadow:
        inset 0 0 6px rgba(0,0,0,0.9),
        inset 0 0 10px rgba(255, 0, 40, 0.25);
}

#anmerkungText::placeholder {
    color: #b38c76;
}

/* ============================
ANMERKUNG ‚Äì COUNTER (Bloodcore R2)
============================ */
#anmerkungCounter {
    font-size: 12px;
    color: #f7dfaf;
    text-align: right;
    opacity: 0.9;

    letter-spacing: 0.3px;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);
}

/* ============================
KOPFZEILE ‚Äì TITEL "Heldenbrief"
============================ */
#heldenbriefBanner {
    width: 600px;
    height: 160px;
    margin: 30px auto 0 auto;

    /* HIER DEIN PINTEREST-BANNER EINSETZEN */
    background-image: url('https://pin.it/6yLWAkUDB');
    background-size: cover;
    background-repeat: no-repeat;
    background-position: center;

    display: flex;
    justify-content: center;
    align-items: center;

    position: relative;
}

/* Textblock */
.heldenbriefText {
    text-align: center;
    padding: 10px 20px;
}

/* Titel */
.heldenbriefTitel {
    font-size: 28px;
    font-weight: bold;
    font-family: "Georgia", serif;
    color: #ffe9c4;
    font-style: italic;
    line-height: 1.3;

    text-shadow:
        0 0 6px rgba(255, 200, 80, 0.7),
        0 0 14px rgba(140, 80, 255, 0.45);
}

/* Name */
.heldenbriefName {
    margin-top: 4px;
    font-size: 20px;
    font-family: "Georgia", serif;
    color: #f5f1ff;
    font-style: italic;
    line-height: 1.3;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.5),
        0 0 10px rgba(106, 13, 173, 0.3);
}
.heldenbriefName {
    margin-top: 4px;
    font-size: 20px;
    font-family: "Georgia", serif;
    color: #f5f1ff;
    font-style: italic;
    line-height: 1.3;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.5),
        0 0 10px rgba(106, 13, 173, 0.3);
}


/* ============================
KOPFZEILE ‚Äì NAME (Bloodcore R2)
============================ */
#hero-header {
    text-align: center;
    height: 160px;
    display: flex;
    flex-direction: column;
    justify-content: center;
    margin-bottom: 25px;
}

#hero-title-main {
    font-size: 40px;
    font-weight: 700;
    color: #ffe9c4;
    font-style: italic;
    text-shadow:
        0 0 6px rgba(255, 200, 80, 0.7),
        0 0 14px rgba(140, 80, 255, 0.45);
    letter-spacing: 2px;
}

#hero-title-name {
    margin-top: 6px;
    font-size: 22px;
    color: #ffffff;
    opacity: 0.9;
    letter-spacing: 1px;
}

/* ============================
DREIER-LINIE ‚Äì Bloodcore R2
============================ */
#merkmale-row {
    width: 950px;
    max-width: 950px;
    margin: 0 auto 24px auto;

    display: flex;
    flex-wrap: wrap;
    justify-content: space-between;
    align-items: flex-start;
    gap: 20px;

    padding-top: 6px;
    border-top: 1px solid rgba(255, 210, 120, 0.4);
    box-sizing: border-box;
}





/* ============================
MERKMALE LINKS ‚Äì Bloodcore R2
============================ */
#merkmale-links {
    flex: 1;
    min-width: 475px;
    max-width: 530px;

    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;

    border-radius: 6px;
    padding: 16px 18px;

    box-shadow:
        0 0 28px rgba(0,0,0,1),
        0 0 26px rgba(255, 60, 60, 0.55),
        0 0 18px rgba(255, 200, 80, 0.45),
        inset 0 0 18px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);

    box-sizing: border-box;
}

/* ============================
MERKMALE ‚Äì TITEL (Bloodcore R2)
============================ */
.merk-title {
    text-align: center;
    font-size: 18px;
    font-weight: bold;

    color: #ffe9b4;
    letter-spacing: 0.6px;

    border-bottom: 1px solid rgba(255, 210, 120, 0.6);
    padding-bottom: 6px;
    margin-bottom: 12px;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 10px rgba(255, 60, 60, 0.4);
}

/* ============================
MERKMALE ‚Äì GRID (Bloodcore R2)
============================ */
.merk-list {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px 20px;
    width: 100%;
    box-sizing: border-box;
}

/* ============================
MERKMAL ‚Äì EINZELFELD (Bloodcore R2)
============================ */
.merk-item {
    position: relative;

    background: rgba(10, 4, 6, 0.92);
    padding: 10px 14px;
    border-radius: 4px;

    border: 1px solid #8a5200;
    box-shadow:
        inset 0 0 6px rgba(0,0,0,0.9),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        0 0 8px rgba(255, 60, 60, 0.25);

    display: flex;
    justify-content: space-between;
    align-items: center;

    font-size: 14px;
    color: #ffe9d8;

    box-sizing: border-box;
}

/* ============================
MERKMAL ‚Äì ECKEN-ORNAMENTE (Bloodcore R2)
============================ */
.merk-item::before,
.merk-item::after {
    content: "";
    position: absolute;
    width: 12px;
    height: 12px;

    border: 1px solid #e2b44a;
    opacity: 0.9;
}

.merk-item::before {
    top: -3px;
    left: -3px;
    border-right: none;
    border-bottom: none;
    border-radius: 3px 0 0 0;
}

.merk-item::after {
    bottom: -3px;
    right: -3px;
    border-left: none;
    border-top: none;
    border-radius: 0 0 3px 0;
}

/* ============================
MERKMAL ‚Äì LABEL LINKS (Bloodcore R2)
============================ */
.merk-item span:first-child {
    color: #ffe9b4;
    font-weight: bold;
    letter-spacing: 0.4px;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);
}
/* ============================
PORTRAIT ‚Äì DSA Retro
============================ */
#portrait-block {
    flex: 1;
    min-width: 200px;
    max-width: 260px;

    background: #f2e9d8;                 /* Pergament */
    border: 2px solid #5a4633;           /* dunkles Sepia */
    border-radius: 4px;

    padding: 12px 14px;
    position: relative;

    display: flex;
    flex-direction: column;
    justify-content: center;

    box-shadow:
        0 2px 4px rgba(0,0,0,0.15),
        inset 0 0 2px rgba(255,255,255,0.4); /* Papierstruktur */
    box-sizing: border-box;
}

/* Rahmen-Ornament */
#portrait-block::before {
    content: "";
    position: absolute;
    inset: 6px;
    border: 1px solid #bfa98a;           /* warmes Sepia */
    border-radius: 3px;
    opacity: 0.8;
    pointer-events: none;
}





/* ============================
PORTRAIT ‚Äì INNENBEREICH (Bloodcore R2)
============================ */
#portrait-inner {
    width: 100%;
    aspect-ratio: 3 / 4;
    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border-radius: 6px;
    overflow: hidden;

    display: flex;
    justify-content: center;
    align-items: center;

    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;

    box-shadow:
        0 0 22px rgba(0,0,0,1),
        0 0 18px rgba(255, 60, 60, 0.45),
        inset 0 0 16px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);

    box-sizing: border-box;
}





/* Bild */
#portrait-img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: none;
}

/* Platzhalter */
#portrait-placeholder {
    width: 100%;
    height: 100%;
    color: #ffe9c4;
    font-size: 14px;
    opacity: 0.8;

    display: flex;
    justify-content: center;
    align-items: center;

    text-shadow:
        0 0 6px rgba(255, 200, 80, 0.7),
        0 0 12px rgba(255, 60, 60, 0.4);
}

/* ============================
DIAGRAMM ‚Äì AUSSENBLOCK (Bloodcore R2)
============================ */
#diagramm-block {
    flex: 1;
    min-width: 180px;
    max-width: 240px;

    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;

    border-radius: 6px;
    padding: 12px 14px;
    position: relative;

    display: flex;
    flex-direction: column;
    justify-content: center;

    box-shadow:
        0 0 26px rgba(0,0,0,1),
        0 0 20px rgba(255, 60, 60, 0.45),
        0 0 14px rgba(255, 200, 80, 0.35),
        inset 0 0 14px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);

    box-sizing: border-box;
}

/* ============================
DIAGRAMM ‚Äì ZIERLINIEN (Bloodcore R2)
============================ */
#diagramm-block::before,
#diagramm-block::after {
    content: "";
    position: absolute;
    left: 0;
    width: 100%;
    height: 1px;

    background: linear-gradient(
        to right,
        rgba(255, 210, 120, 0.8),
        rgba(255, 60, 60, 0.6),
        rgba(255, 210, 120, 0.8)
    );
}

#diagramm-block::before {
    top: -6px;
}

#diagramm-block::after {
    bottom: -6px;
}

/* ============================
DIAGRAMM ‚Äì INNENBEREICH (Bloodcore R2)
============================ */
#diagramm-inner {
    width: 100%;
    aspect-ratio: 1 / 1;

    background: rgba(10, 4, 6, 0.92);
    border: 1px solid #8a5200;
    border-radius: 4px;

    overflow: hidden;

    display: flex;
    justify-content: center;
    align-items: center;

    box-shadow:
        inset 0 0 10px rgba(0,0,0,0.9),
        inset 0 0 14px rgba(255, 0, 40, 0.25),
        inset 0 0 6px rgba(255, 200, 80, 0.25);

    box-sizing: border-box;
}

/* ============================
ATTRIBUTE-BLOCK ‚Äì Bloodcore R2
============================ */
#attribute-block {
    width: 950px;
    height: 400px;

    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;

    border-radius: 6px;
    padding: 14px 16px;
    box-sizing: border-box;
    position: relative;
    margin: 0 auto 30px auto;

    box-shadow:
        0 0 28px rgba(0,0,0,1),
        0 0 26px rgba(255, 60, 60, 0.55),
        0 0 18px rgba(255, 200, 80, 0.45),
        inset 0 0 18px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);
}

/* ============================
ATTRIBUTE ‚Äì TITEL (Bloodcore R2)
============================ */
#attribute-title {
    text-align: center;
    font-size: 20px;
    font-weight: bold;

    color: #ffe9b4;
    letter-spacing: 0.8px;

    border-bottom: 1px solid rgba(255, 210, 120, 0.6);
    padding-bottom: 6px;
    margin-bottom: 12px;

    text-shadow:
        0 0 6px rgba(255, 200, 80, 0.7),
        0 0 14px rgba(255, 60, 60, 0.45);
}

/* ============================
ATTRIBUTE ‚Äì GRID
============================ */
#attribute-grid {
    display: auto;
    flex-direction: auto;
    gap: 6px;
    height: calc(100% - 34px);
}

.row {
    display: grid;
    grid-template-columns: auto(17 fr);
    gap: 6px;
}

.center-row {
    display: flex;
    justify-content: center;
    gap: 40px;
}





/* ============================
ATTRIBUTE ‚Äì SLOT (Bloodcore R2)
============================ */
.attribute-slot {
    background: rgba(10, 4, 6, 0.92);
    border: 1px solid #8a5200;
    border-radius: 4px;

    padding: 4px 16px;
    display: grid;
    grid-template-columns: 2fr auto auto;
    align-items: center;

    font-size: 17px;
    color: #ffe9d8;

    box-shadow:
        inset 0 0 10px rgba(0,0,0,0.9),
        inset 0 0 14px rgba(255, 0, 40, 0.25),
        inset 0 0 6px rgba(255, 200, 80, 0.25),
        0 0 8px rgba(255, 60, 60, 0.25);
}

/* ============================
ATTRIBUTE ‚Äì LEVEL (Bloodcore R2)
============================ */
.attr-level {
    color: #ffe9b4;
    font-weight: bold;
    margin-right: 4px;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);
}

/* ============================
ATTRIBUTE ‚Äì PFEILE (Bloodcore R2)
============================ */
.attr-arrow {
    width: 18px;
    height: 18px;

    background: rgba(10, 4, 6, 0.92);
    border: 1px solid #8a5200;
    border-radius: 3px;

    color: #ffe9b4;
    cursor: pointer;

    display: flex;
    justify-content: center;
    align-items: center;

    font-weight: bold;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);

    box-shadow:
        inset 0 0 6px rgba(0,0,0,0.9),
        inset 0 0 10px rgba(255, 0, 40, 0.25);
}

.attr-arrow:hover {
    background: rgba(40, 10, 10, 0.95);
    border-color: #ffe9a8;
    color: #ffe9a8;

    box-shadow:
        0 0 10px rgba(255, 200, 80, 0.8),
        0 0 14px rgba(255, 60, 60, 0.5),
        inset 0 0 10px rgba(255, 200, 80, 0.25);
}
/* ============================
VITALWERTE + AUFWERTUNGEN ‚Äì UNDRA Bloodcore R2
============================ */
#vitalWrapper {
    width: 950px;
    margin: 0 auto 40px auto;

    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
}

/* ============================
VITALWERTE ‚Äì BOXEN (Bloodcore R2)
============================ */
#vitalDisplay,
#vitalBonusPanel {
    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;
    border-radius: 6px;

    padding: 16px 18px;
    box-sizing: border-box;

    box-shadow:
        0 0 28px rgba(0,0,0,1),
        0 0 26px rgba(255, 60, 60, 0.55),
        0 0 18px rgba(255, 200, 80, 0.45),
        inset 0 0 18px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);
}

/* ============================
VITALWERTE ‚Äì TITEL (Bloodcore R2)
============================ */
.vital-title {
    text-align: center;
    font-size: 20px;
    font-weight: 700;

    color: #ffe9b4;
    letter-spacing: 1px;

    border-bottom: 1px solid rgba(255, 210, 120, 0.6);
    padding-bottom: 6px;
    margin-bottom: 14px;

    text-shadow:
        0 0 6px rgba(255, 200, 80, 0.7),
        0 0 14px rgba(255, 60, 60, 0.45);
}

/* ============================
VITALWERTE ‚Äì EINZELZEILE (Bloodcore R2)
============================ */
.vital-row {
    display: grid;
    grid-template-columns: 40px 1fr auto;
    align-items: center;

    padding: 6px 6px;
    margin-bottom: 10px;

    background: rgba(10, 4, 6, 0.92);
    border-radius: 4px;
    border: 1px solid #8a5200;

    box-shadow:
        inset 0 0 10px rgba(0,0,0,0.9),
        inset 0 0 14px rgba(255, 0, 40, 0.25),
        inset 0 0 6px rgba(255, 200, 80, 0.25),
        0 0 8px rgba(255, 60, 60, 0.25);
}

/* ============================
VITALWERTE ‚Äì ICON (Bloodcore R2)
============================ */
.vital-icon {
    font-size: 22px;
    text-align: center;
    color: #ffe9b4;

    text-shadow:
        0 0 6px rgba(255, 200, 80, 0.7),
        0 0 12px rgba(255, 60, 60, 0.4);
}

/* ============================
VITALWERTE ‚Äì LABEL (Bloodcore R2)
============================ */
.vital-label {
    color: #ffe9d8;
    font-weight: 600;
    font-size: 15px;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);
}

/* ============================
VITALWERTE ‚Äì WERT (Bloodcore R2)
============================ */
.vital-value {
    color: #fff4e6;
    font-size: 15px;
    text-align: right;
    font-weight: bold;

    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);
}

/* ============================
ICON-ANIMATIONEN (unver√§ndert)
============================ */
.heart { animation: heartPulse 1.8s infinite ease-in-out; }
@keyframes heartPulse {
    0% { transform: scale(1); }
    50% { transform: scale(1.12); }
    100% { transform: scale(1); }
}

.energy { animation: energyZap 1.4s infinite; }
@keyframes energyZap {
    0%, 90% { transform: translateX(0); }
    92% { transform: translateX(-2px); }
    94% { transform: translateX(2px); }
    96% { transform: translateX(-1px); }
    100% { transform: translateX(0); }
}

.shield { animation: shieldShine 3s infinite linear; }
@keyframes shieldShine {
    0% { filter: brightness(1); }
    50% { filter: brightness(1.35); }
    100% { filter: brightness(1); }
}

.brain { animation: brainWave 2.4s infinite ease-in-out; }
@keyframes brainWave {
    0% { filter: drop-shadow(0 0 2px #6a3f8f); }
    50% { filter: drop-shadow(0 0 8px #b57cff); }
    100% { filter: drop-shadow(0 0 2px #6a3f8f); }
}

.target { animation: targetPing 2.2s infinite ease-out; }
@keyframes targetPing {
    0% { transform: scale(1); opacity: 1; }
    70% { transform: scale(1.15); opacity: 0.6; }
    100% { transform: scale(1); opacity: 1; }
}





/* ============================
AUFWERTUNGEN ‚Äì OPTIMIERTE ABST√ÑNDE (Bloodcore R2)
============================ */

.vb-row {
    display: grid;
    grid-template-columns: 28px 1fr auto auto;
    align-items: center;
    gap: 10px;
    margin-bottom: 12px;

    min-height: 40px; /* sorgt f√ºr identische Zeilenh√∂he */
}

/* Label links */
.vb-label {
    font-size: 0.85rem;
    color: #ffe9d8;
    line-height: 1;
    padding-top: 2px; /* optische Zentrierung */
}

/* Icon */
.vb-icon {
    font-size: 22px;
    width: 28px;
    text-align: center;
    color: #ffe9b4;

    display: flex;
    justify-content: center;
    align-items: center;

    text-shadow:
        0 0 6px rgba(255, 200, 80, 0.7),
        0 0 12px rgba(255, 60, 60, 0.4);
}

/* Crystal‚ÄëReihe */
.vb-crystals {
    display: flex;
    gap: 6px;
    align-items: center; /* vertikale Zentrierung */
    height: 100%;
}

.vb-crystal {
    width: 36px;
    height: 12px;
    border-radius: 6px;
    background: rgba(40, 20, 20, 0.6);
    transition: 0.2s;
}

.vb-crystal.active {
    background: linear-gradient(90deg, #ffe9a8, #e2b44a);
    box-shadow:
        0 0 10px rgba(255, 200, 80, 0.9),
        0 0 14px rgba(255, 60, 60, 0.5);
}

/* Upgrade‚ÄëButton */
.vb-upgrade {
    background: linear-gradient(90deg, #ffe9a8, #e2b44a);
    border: 2px solid #8a5200;
    border-radius: 6px;
    cursor: pointer;
    padding: 4px 10px;

    font-size: 0.8rem;
    font-weight: 600;
    color: #111;

    display: flex;
    align-items: center;
    justify-content: center;

    height: 28px; /* exakt gleiche H√∂he wie Icons */
    box-shadow:
        0 0 10px rgba(255, 200, 80, 0.8),
        0 0 14px rgba(255, 60, 60, 0.5);
}

.vb-upgrade:disabled {
    opacity: 0.4;
    cursor: default;
}

/* ============================
KAMPF + R√úSTUNGSSYSTEM ‚Äì Bloodcore R2 (Fix)
============================ */
#kampfWrapper {
    width: 450px;
    max-width: 100%;
    margin: 0 auto 40px auto;

    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 12px;

    box-sizing: border-box;
}

/* Alle Elemente im Wrapper d√ºrfen NICHT breiter werden als die Spalte */
#kampfWrapper > div {
    display: flex;
    flex-direction: column;
    max-width: 100%;
    box-sizing: border-box;
}

/* ============================
LINKER BLOCK ‚Äì ANGRIFF (Bloodcore R2)
============================ */
.kampf-panel {
    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;
    border-radius: 6px;

    padding: 14px 16px;
    min-height: 260px;

    display: flex;
    flex-direction: column;
    gap: 12px;

    box-shadow:
        0 0 26px rgba(0,0,0,1),
        0 0 20px rgba(255, 60, 60, 0.45),
        0 0 14px rgba(255, 200, 80, 0.35),
        inset 0 0 14px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);
}

/* Kampfzeilen */
.kampf-row {
    display: grid;
    grid-template-columns: 1fr auto;
    align-items: center;

    padding: 8px 8px;
    background: rgba(10, 4, 6, 0.92);
    border-radius: 4px;

    border: 1px solid #8a5200;
    box-shadow:
        inset 0 0 10px rgba(0,0,0,0.9),
        inset 0 0 14px rgba(255, 0, 40, 0.25),
        inset 0 0 6px rgba(255, 200, 80, 0.25),
        0 0 8px rgba(255, 60, 60, 0.25);
}

.kampf-label {
    color: #ffe9b4;
    font-weight: 700;
    font-size: 15px;
    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);
}

.kampf-value {
    color: #fff4e6;
    font-size: 15px;
    text-align: right;
    font-weight: bold;
    text-shadow:
        0 0 4px rgba(255, 200, 80, 0.7),
        0 0 8px rgba(255, 60, 60, 0.4);
}

/* ============================
RECHTER BLOCK ‚Äì R√úSTUNGSSYSTEM (Bloodcore R2)
============================ */
#ruestungsBlock {
    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;
    border-radius: 6px;

    padding: 14px 16px;

    box-shadow:
        0 0 26px rgba(0,0,0,1),
        0 0 20px rgba(255, 60, 60, 0.45),
        0 0 14px rgba(255, 200, 80, 0.35),
        inset 0 0 14px rgba(255, 200, 80, 0.25),
        inset 0 0 10px rgba(255, 0, 40, 0.25),
        inset 0 0 4px rgba(255,255,255,0.08);
}

/* ============================
R√úSTUNGSSYSTEM ‚Äì INNENBLOCK
============================ */
#armorSystem {
    width: 100%;              /* statt 475px */
    max-width: 100%;          /* verhindert √úberbreite */
    background: rgba(10, 4, 6, 0.92);
    border: 1px solid #8a5200;
    border-radius: 6px;

    padding: 6px;             /* kompakter */
    font-size: 11px;
    color: #ffe9d8;
    font-family: "Georgia", serif;

    min-height: 260px;

    display: flex;
    flex-direction: row;
    justify-content: space-between; /* M√§nnchen + Werte sauber verteilt */
    gap: 6px;

    box-sizing: border-box;   /* verhindert √úberlaufen */
    overflow: hidden;         /* falls etwas minimal √ºbersteht */
}



/* Linke Seite */
#armorLeft {
    width: 70%;
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* ============================
ZONEN-AUSWAHL
============================ */
#zoneSelectGrid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 8px 20px;

    background: rgba(0,0,0,0.6);
    padding: 10px;
    border-radius: 8px;
    border: 1px solid #8a5200;

    box-shadow:
        inset 0 0 10px rgba(0,0,0,0.9),
        inset 0 0 14px rgba(255, 0, 40, 0.25);
}

#zoneSelectGrid div {
    padding: 6px 8px;
    background: rgba(40, 20, 20, 0.6);
    border-radius: 4px;
    cursor: pointer;
    transition: 0.15s ease;
    color: #ffe9d8;
}

#zoneSelectGrid div:hover {
    background: rgba(255, 200, 80, 0.15);
    transform: translateY(-1px);
}

#zoneSelectGrid div.active-zone {
    background: linear-gradient(90deg, #ffe9a8, #e2b44a);
    border: 1px solid #8a5200;
    color: #111;
    box-shadow:
        0 0 10px rgba(255, 200, 80, 0.9),
        0 0 14px rgba(255, 60, 60, 0.5);
}

/* Inputs */
#armorLeft input,
#armorLeft button {
    width: 100%;
    height: 22px;
    font-size: 11px;

    background: rgba(10, 4, 6, 0.92);
    border: 1px solid #8a5200;
    color: #ffe9d8;
    border-radius: 3px;

    box-shadow:
        inset 0 0 6px rgba(0,0,0,0.9),
        inset 0 0 10px rgba(255, 0, 40, 0.25);
}

/* Zonenliste */
#zoneList {
    flex: 1;
    font-size: 11px;
    line-height: 14px;
    color: #ffe9d8;
}

.zone-box {
    margin-bottom: 6px;
    padding-bottom: 4px;
    border-bottom: 1px solid #8a5200;
}





/* ============================
RECHTE SEITE ‚Äì FIGUR
============================ */
#armorRight {
    width: 30%;
    background: #000;
    border: 1px solid #8a5200;
    border-radius: 4px;

    min-height: 260px;

    display: flex;
    justify-content: center;
    align-items: center;

    box-shadow:
        inset 0 0 10px rgba(0,0,0,0.9),
        inset 0 0 14px rgba(255, 0, 40, 0.25);
}

#zoneFigure {
    width: 100%;
    height: 100%;
}

/* ============================
SVG-ZONEN
============================ */
.armor-zone {
    fill: #4b5563;
    stroke: #8a5200;
    stroke-width: 2;
    transition: 0.2s ease;
    cursor: pointer;
}

.armor-zone:hover {
    filter: brightness(1.3);
    stroke: #ffe9a8;
}

.active-zone-svg {
    stroke: #ffe9a8 !important;
    stroke-width: 3 !important;
    filter: drop-shadow(0 0 6px #ffe9a8);
}






/* ============================
POPUP ‚Äì Bloodcore R2
============================ */
.popup-bg {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.72);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(4px);
}

/* sichtbarer Zustand (z.B. .popup-bg.active) */
.popup-bg.active {
    display: flex;
}

/* Popup-Karte */
.popup {
    width: 280px;
    max-width: calc(100% - 40px);
    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    color: #fff4e6;
    padding: 14px;
    border-radius: 8px;
    box-sizing: border-box;

    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;

    box-shadow:
        0 0 30px rgba(0,0,0,0.95),
        0 0 22px rgba(255,60,60,0.45),
        0 0 14px rgba(255,200,80,0.35),
        inset 0 0 12px rgba(255,200,80,0.18);

    font-size: 13px;
    line-height: 1.3;
    text-align: center;
}

/* Kopfzeile / Titel innerhalb des Popups (optional) */
.popup .title {
    font-weight: 700;
    color: #ffe9b4;
    margin-bottom: 8px;
    text-shadow:
        0 0 6px rgba(255,200,80,0.7),
        0 0 12px rgba(255,60,60,0.35);
}

/* Inhaltstext */
.popup p {
    margin: 0 0 10px 0;
    color: #fff1df;
}

/* Buttons */
.popup button {
    width: 100%;
    height: 34px;
    margin-top: 6px;
    padding: 6px 10px;
    border-radius: 6px;

    background: linear-gradient(90deg, #ffe9a8, #e2b44a);
    border: 2px solid #8a5200;
    color: #111;
    font-weight: 700;
    cursor: pointer;

    box-shadow:
        0 0 10px rgba(255,200,80,0.85),
        0 0 14px rgba(255,60,60,0.45),
        inset 0 0 6px rgba(255,255,255,0.12);
}

/* Button Hover / Focus */
.popup button:hover,
.popup button:focus {
    transform: translateY(-1px);
    box-shadow:
        0 0 14px rgba(255,200,80,0.95),
        0 0 18px rgba(255,60,60,0.55),
        inset 0 0 8px rgba(255,255,255,0.14);
    outline: none;
}

/* Sekund√§rer Button (z.B. Abbrechen) */
.popup .btn-secondary {
    background: rgba(10,4,6,0.92);
    color: #ffe9b4;
    border: 1px solid rgba(255,210,120,0.25);
    box-shadow:
        inset 0 0 6px rgba(0,0,0,0.9),
        0 0 8px rgba(255,60,60,0.18);
}

/* Accessibility: Fokus sichtbar */
.popup button:focus-visible {
    outline: 3px solid rgba(255,200,80,0.25);
    outline-offset: 2px;
}
/* ============================
INVENTAR, TIMELINE, FOOTER ‚Äì Bloodcore R2
============================ */
#inventoryWrapper {
    width: 950px;
    margin: 0 auto 18px auto;
}

#inventoryPanel {
    display: flex;
    gap: 12px;
    justify-content: space-between;
}

/* Inventar Spalte */
.inv-column {
    width: 950px;
    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-image: linear-gradient(to bottom, #ffe9a8, #e2b44a, #8a5200) 1;
    padding: 10px;
    border-radius: 6px;
    box-sizing: border-box;
    color: #fff4e6;
    box-shadow:
        0 0 22px rgba(0,0,0,1),
        0 0 18px rgba(255,60,60,0.45),
        inset 0 0 12px rgba(255,200,80,0.18);
}

.inv-title {
    color: #ffe9b4;
    font-weight: bold;
    margin-bottom: 8px;
    text-shadow:
        0 0 6px rgba(255,200,80,0.7),
        0 0 10px rgba(255,60,60,0.35);
}

/* Inventarzeilen */
.inv-list .inv-row {
    display: flex;
    gap: 6px;
    margin-bottom: 6px;
    align-items: center;
}

.inv-row input {
    flex: 1;
    padding: 6px;
    background: rgba(10,4,6,0.92);
    border: 1px solid #8a5200;
    color: #fff4e6;
    border-radius: 4px;
    box-shadow:
        inset 0 0 6px rgba(0,0,0,0.9),
        inset 0 0 8px rgba(255,0,40,0.18);
}

/* Aktionstaste */
.inv-action {
    width: 100%;
    max-width: 950px;
    height: 34px;
    background: linear-gradient(90deg, #ffe9a8, #e2b44a);
    border: 2px solid #8a5200;
    border-radius: 6px;
    cursor: pointer;
    color: #111;
    font-weight: 700;
    box-shadow:
        0 0 10px rgba(255,200,80,0.85),
        0 0 14px rgba(255,60,60,0.45);
}

.uf-popup-bg {
    position: fixed;
    top:0; left:0;
    width:100%; height:100%;
    background: rgba(0,0,0,0.75);
    display:flex;
    align-items:center;
    justify-content:center;
    z-index:999;
}

.uf-popup {
    background:#120a12;
    border:2px solid gold;
    border-radius:10px;
    padding:16px;
    width:360px;
    color:#ffe7c2;
}

.uf-popup-title {
    margin-top:0;
    color:#f5d77a;
    text-align:center;
}

.uf-input {
    width:100%;
    padding:6px;
    margin:4px 0 10px 0;
    background:#1a0f1a;
    border:1px solid #8a5200;
    color:#ffe7c2;
    border-radius:4px;
}

.uf-btn {
    padding:6px 12px;
    background:#1a0f1a;
    border:1px solid #8a5200;
    color:#ffdca8;
    border-radius:4px;
    cursor:pointer;
}



/* ============================
TAP PROGRESS
============================ */
#tap-progress-container {
    width: 950px;
    margin: 18px auto 12px auto;
    background: linear-gradient(135deg, #12020a 0%, #070306 100%);
    border: 2px solid #8a5200;
    border-radius: 6px;
    padding: 8px;
    box-sizing: border-box;
    box-shadow:
        0 0 20px rgba(0,0,0,0.95),
        0 0 14px rgba(255,60,60,0.35);
}

#tap-progress-bar {
    height: 18px;
    width: 100%;
    background: linear-gradient(90deg, #4b5563, #6b7280);
    border-radius: 4px;
    transition: width 0.3s;
    box-shadow: inset 0 0 6px rgba(0,0,0,0.6);
}

#tap-progress-text {
    color: #fff4e6;
    margin-top: 6px;
    text-align: right;
    font-size: 12px;
    text-shadow:
        0 0 4px rgba(255,200,80,0.6);
}

/* ============================
TIMELINE 2x30 ‚Äì Bloodcore R2 (funktionierende Version)
============================ */
#tap-timeline {
    width: 950px;
    margin: 0 auto 20px auto;
    background: linear-gradient(135deg, #3a0006 0%, #150003 45%, #000000 100%);
    border: 2px solid #8a5200;
    border-radius: 6px;
    padding: 10px;
    box-sizing: border-box;
    color: #fff4e6;
    box-shadow:
        0 0 22px rgba(0,0,0,1),
        0 0 18px rgba(255,60,60,0.45);

    display: grid;
    grid-template-columns: repeat(30, 1fr); /* 30 Felder pro Zeile */
    grid-auto-rows: 48px;                   /* H√∂he jeder Zeile */
    gap: 8px;
}

/* Einzelner Tag */
.tap-day {
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;

    background: rgba(10,4,6,0.92);
    border: 1px solid #8a5200;
    border-radius: 4px;
    color: #fff4e6;

    padding: 4px;
    font-size: 12px;

    box-shadow:
        inset 0 0 8px rgba(0,0,0,0.9),
        0 0 6px rgba(255,60,60,0.12);
}

/* Tagnummer */
.tap-day .day-num {
    font-weight: 700;
    color: #ffe9b4;
    margin-bottom: 2px;
    text-shadow:
        0 0 4px rgba(255,200,80,0.7),
        0 0 8px rgba(255,60,60,0.35);
}
/* optionaler Text */
.tap-day .day-text {
    font-size: 11px;
    color: #fff4e6;
    opacity: 0.95;
}

/* Hover / aktive Tage */
.tap-day:hover {
    transform: translateY(-2px);
    box-shadow:
        0 0 14px rgba(255,200,80,0.9),
        0 0 18px rgba(255,60,60,0.45);
    cursor: pointer;
}

/* Markierter Tag */
.tap-day.active {
    background: linear-gradient(90deg, #ffe9a8, #e2b44a);
    color: #111;
    border: 2px solid #8a5200;
    box-shadow:
        0 0 12px rgba(255,200,80,0.95),
        0 0 18px rgba(255,60,60,0.5);
}

/* Responsive: bei kleinen Bildschirmen horizontal scrollen */
@media (max-width: 980px) {
    #tap-timeline {
        display: block;
        overflow-x: auto;
        white-space: nowrap;
        padding-bottom: 12px;
    }
   





/* ============================
FOOTER
============================ */
#undra-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 8px 14px;
    margin: 12px 10px 0 10px;
    background: #0a050a;
    border-top: 2px solid gold;
    border-radius: 0 0 6px 6px;
    color: #ffe7c2;
    font-size: 13px;
}

.uf-btn {
    padding: 6px 12px;
    background: rgba(20,10,12,0.9);
    border: 1px solid #8a5200;
    border-radius: 4px;
    color: #ffdca8;
    cursor: pointer;
    text-shadow: 0 0 4px rgba(255,200,80,0.6);
}

.uf-btn:hover {
    background: rgba(40,20,22,0.9);
}

#uf-center {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2px;
}

.uf-value {
    color: #fff4e6;
    text-shadow: 0 0 4px rgba(255,200,80,0.6);
}

.uf-label {
    color: gold;
}
/* ============================
RESPONSIVE TWEAKS (Bloodcore R2)
============================ */
@media (max-width:1000px) {
  body { padding:12px 6px; }
  #merkmale-row, #attribute-block, #vitalWrapper, #kampfWrapper, #inventoryWrapper, #tap-timeline, #footer-container {
    width: 950px !important;
    max-width: 100% !important;
  }
  .row { grid-template-columns: repeat(2,1fr); }
}
</style>
</head>

<body>

<!-- ============================
KOPFZEILE
============================ -->
<div id="heldenbriefBanner">
    <div class="heldenbriefText">
        <div class="heldenbriefTitel">Heldenbrief</div>
        <div class="heldenbriefName" id="heldenbriefName"></div>
    </div>
</div>

<!-- ============================
DREIER-LINIE
============================ -->
<div id="merkmale-row">

    <!-- Merkmale links -->
    <div id="merkmale-links">
        <div class="merk-title">K√ñRPERLICHE MERKMALE</div>
        <div class="merk-list">
            <div class="merk-item"><span>Alter</span><span id="ml-age">‚Äì</span></div>
            <div class="merk-item"><span>Gr√∂√üe</span><span id="ml-height">‚Äì</span></div>
            <div class="merk-item"><span>Gewicht</span><span id="ml-weight">‚Äì</span></div>
            <div class="merk-item"><span>Augenfarbe</span><span id="ml-eyes">‚Äì</span></div>
            <div class="merk-item"><span>Haarfarbe</span><span id="ml-hair">‚Äì</span></div>
            <div class="merk-item"><span>Stimme</span><span id="ml-voice">‚Äì</span></div>
            <div class="merk-item"><span>Kleidung / R√ºstung</span><span id="ml-armor">‚Äì</span></div>
            <div class="merk-item"><span>Besondere Merkmale</span><span id="ml-special">‚Äì</span></div>
        </div>
    </div>

    <!-- Portrait -->
    <div id="portrait-block">
        <div id="portrait-inner">
            <img id="portrait-img" src="" alt="Portrait">
            <div id="portrait-placeholder">PORTRAIT</div>
        </div>
    </div>

    <!-- Diagramm -->
    <div id="diagramm-block">
        <div id="diagramm-inner">
            <canvas id="radarCanvas" width="175" height="175"></canvas>
        </div>
    </div>

</div>

<!-- ============================
ATTRIBUTE-BLOCK
============================ -->
<div id="attribute-block">
    <div id="attribute-title">Attribut‚ÄëF√§higkeiten</div>
    <div id="attribute-grid">

        <div class="row">
            <div class="attribute-slot" data-short="MU"><span class="attr-name">Mut (MU)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            
            <div class="attribute-slot" data-short="IN"><span class="attr-name">Intelligenz (IN)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="FF"><span class="attr-name">Fingerfertigkeit (FF)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="GE"><span class="attr-name">Gewandtheit (GE)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="KK"><span class="attr-name">K√∂rperkraft (KK)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
        </div>













        <div class="row">
            <div class="attribute-slot" data-short="KB"><span class="attr-name">K√∂rperbewusstsein (KB)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="KO"><span class="attr-name">Konstitution (KO)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="CH"><span class="attr-name">Charisma (CH)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="SS"><span class="attr-name">Sozialstatus (SS)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="GZ"><span class="attr-name">Geistiger Zustand (GZ)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
        </div>

        <div class="row">
            <div class="attribute-slot" data-short="IT"><span class="attr-name">Intuition (IT)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="AN"><span class="attr-name">Angriff (AN)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="VE"><span class="attr-name">Verteidigung (VE)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="AS"><span class="attr-name">Abwehrschlag (AS)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="FK"><span class="attr-name">Fernkampf (FK)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
        </div>

        <div class="row center-row">
            <div class="attribute-slot" data-short="TC"><span class="attr-name">Trefferchance (TC)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
            <div class="attribute-slot" data-short="TE"><span class="attr-name">Technik (TE)</span><span class="attr-level">0</span><button class="attr-arrow">‚ñ≤</button></div>
        </div>

    </div>
</div>

<!-- ============================
VITALWERTE + AUFWERTUNGEN
============================ -->
<div id="vitalWrapper">

    <!-- LINKER BLOCK: Vitalwerte -->
    <div id="vitalDisplay">
        <div class="vital-title">Vitalwerte</div>

        <div class="vital-row">
            <div class="vital-icon heart">‚ù§Ô∏è</div>
            <div class="vital-label">Leben</div>
            <div class="vital-value" id="vital-le">‚Äì</div>
        </div>

        <div class="vital-row">
            <div class="vital-icon energy">‚ö°</div>
            <div class="vital-label" id="vital-dyn-label">Ausdauer</div>
            <div class="vital-value" id="vital-dyn">‚Äì</div>
        </div>

        <div class="vital-row">
            <div class="vital-icon shield">üõ°Ô∏è</div>
            <div class="vital-label">R√ºstung</div>
            <div class="vital-value" id="vital-ruest">‚Äì</div>
        </div>

        <div class="vital-row">
            <div class="vital-icon brain">üß†</div>
            <div class="vital-label">Geistige Gesundheit</div>
            <div class="vital-value" id="vital-gg">‚Äì</div>
        </div>

        <div class="vital-row">
            <div class="vital-icon target">üéØ</div>
            <div class="vital-label">Trefferchance</div>
            <div class="vital-value" id="vital-tc">‚Äì</div>
        </div>
    </div>





    <!-- RECHTER BLOCK: Aufwertungen -->
    <div id="vitalBonusPanel">
        <div class="vital-title">Aufwertungen</div>

        <div class="vb-row">
            <div class="vb-label">(LE)</div>
            <div class="vb-icon">‚ù§Ô∏è</div>
            <div class="vb-crystals" data-stat="LE"></div>
            <button class="vb-upgrade" data-stat="LE">‚ñ≤</button>
        </div>

        <div class="vb-row">
            <div class="vb-label">(R√ºst)</div>
            <div class="vb-icon">üõ°Ô∏è</div>
            <div class="vb-crystals" data-stat="RUEST"></div>
            <button class="vb-upgrade" data-stat="RUEST">‚ñ≤</button>
        </div>

        <div class="vb-row" id="vb-dynamic-row">
            <div class="vb-label" id="vb-dyn-label">(AU)</div>
            <div class="vb-icon" id="vb-dyn-icon">‚ö°</div>
            <div class="vb-crystals" data-stat="DYN"></div>
            <button class="vb-upgrade" data-stat="DYN">‚ñ≤</button>
        </div>

        <div class="vb-row">
            <div class="vb-label">(GG)</div>
            <div class="vb-icon">üß†</div>
            <div class="vb-crystals" data-stat="GG"></div>
            <button class="vb-upgrade" data-stat="GG">‚ñ≤</button>
        </div>

        <div class="vb-row">
            <div class="vb-label">(TC)</div>
            <div class="vb-icon">üéØ</div>
            <div class="vb-crystals" data-stat="TC"></div>
            <button class="vb-upgrade" data-stat="TC">‚ñ≤</button>
        </div>
    </div>

</div>

<!-- ============================
KAMPF + R√úSTUNGSSYSTEM
============================ -->
<div id="kampfWrapper">

    <!-- LINKER BLOCK: Angriffsblock -->
    <div id="angriffsBlock" class="kampf-panel">
        <div class="vital-title">Angriffsblock</div>

        <div class="kampf-row">
            <div class="kampf-label">Angriff</div>
            <div class="kampf-value" id="kampf-angriff">‚Äì</div>
        </div>

        <div class="kampf-row">
            <div class="kampf-label">Verteidigung</div>
            <div class="kampf-value" id="kampf-verteidigung">‚Äì</div>
        </div>

        <div class="kampf-row">
            <div class="kampf-label">Abwehr</div>
            <div class="kampf-value" id="kampf-abwehr">‚Äì</div>
        </div>

        <div class="kampf-row">
            <div class="kampf-label">Gegenangriff</div>
            <div class="kampf-value" id="kampf-gegenangriff">‚Äì</div>
        </div>

        <div class="kampf-row">
            <div class="kampf-label">Statusver√§nderung</div>
            <div class="kampf-value" id="kampf-status">‚Äì</div>
        </div>

        <div class="kampf-row">
            <div class="kampf-label">Verbesserte Anpassungen</div>
            <div class="kampf-value" id="kampf-anpassungen">‚Äì</div>
        </div>
        <div id="anmerkungBlock">
    <div class="anmerkung-title">Anmerkung</div>
    <textarea id="anmerkungText" maxlength="500"></textarea>
    <div id="anmerkungCounter">0 / 500</div>
</div>
    </div>









    <!-- RECHTER BLOCK: R√ºstungssystem -->
    <div id="ruestungsBlock">
        <div class="vital-title">R√ºstungssystem</div>

        <div id="armorSystem">

            <!-- Linke Seite -->
            <div id="armorLeft">

                <div id="zoneSelectGrid">
                    <div data-value="1">1. Kopf</div>
                    <div data-value="2">2. Hals</div>
                    <div data-value="3">3. Oberk√∂rper</div>
                    <div data-value="4">4. Linker Arm</div>
                    <div data-value="5">5. Rechter Arm</div>
                    <div data-value="6">6. Unterk√∂rper</div>
                    <div data-value="7">7. Linkes Bein</div>
                    <div data-value="8">8. Rechtes Bein</div>
                </div>

                <input id="damageInput" type="number" placeholder="Schaden">
                <button onclick="applyDamage()">Treffer anwenden</button>
                <button onclick="openArmorPopup()">R√ºstwert</button>

                <div id="zoneList"></div>
            </div>

            <!-- Rechte Seite: Figur -->
            <div id="armorRight">
                <svg id="zoneFigure" viewBox="0 0 120 360">

                    <!-- K√∂rper-Silhouette -->
                    <path d="M60 10
                             C45 10, 40 25, 40 40
                             L40 70
                             C40 85, 30 95, 30 110
                             L30 160
                             C30 180, 40 200, 40 220
                             L40 260
                             C40 280, 50 300, 60 300
                             C70 300, 80 280, 80 260
                             L80 220
                             C80 200, 90 180, 90 160
                             L90 110
                             C90 95, 80 85, 80 70
                             L80 40
                             C80 25, 75 10, 60 10
                             Z"
                          fill="#0d0d0d" stroke="#3a1f47" stroke-width="2"/>










                    <!-- Kopf -->
                    <circle id="zone1" cx="60" cy="35" r="22"
                            class="zone-click armor-zone"/>

                    <!-- Hals -->
                    <rect id="zone2" x="50" y="55" width="20" height="18" rx="4"
                          class="zone-click armor-zone"/>

                    <!-- Brust / Oberk√∂rper -->
                    <rect id="zone3" x="35" y="75" width="50" height="70" rx="10"
                          class="zone-click armor-zone"/>

                    <!-- Linker Arm -->
                    <rect id="zone4" x="20" y="80" width="12" height="80" rx="6"
                          class="zone-click armor-zone"/>

                    <!-- Rechter Arm -->
                    <rect id="zone5" x="88" y="80" width="12" height="80" rx="6"
                          class="zone-click armor-zone"/>

                    <!-- Unterk√∂rper -->
                    <rect id="zone6" x="45" y="150" width="30" height="40" rx="8"
                          class="zone-click armor-zone"/>

                    <!-- Linkes Bein -->
                    <rect id="zone7" x="48" y="190" width="12" height="120" rx="6"
                          class="zone-click  armor-zone"/>

                    <!-- Rechtes Bein -->
                    <rect id="zone8" x="60" y="190" width="12" height="120" rx="6"
                          class="zone-click armor-zone"/>

                </svg>
            </div>

        </div>

        <div id="armorPopup" class="popup-bg">
            <div class="popup">
                <h3 id="popupTitle"></h3>
                <div id="popupContent"></div>
                <button onclick="confirmArmorAction()">Best√§tigen</button>
                <button onclick="closeArmorPopup()">Abbrechen</button>
            </div>
        </div>

    </div>

</div>


<!-- ============================
INVENTAR (erg√§nzt)
============================ -->
<div id="inventoryWrapper">
  <div id="inventoryPanel">
    <div class="inv-column">
      <div class="inv-title">Klein</div>
      <button class="inv-sort" id="sort-small">Sortieren</button>
      <div class="inv-list" id="inv-small"></div>
    </div>

    <div class="inv-column">
      <div class="inv-title">Mittel</div>
      <button class="inv-sort" id="sort-medium">Sortieren</button>
      <div class="inv-list" id="inv-medium"></div>
    </div>

    <div class="inv-column">
      <div class="inv-title">Gro√ü</div>
      <button class="inv-sort" id="sort-large">Sortieren</button>
      <div class="inv-list" id="inv-large"></div>
    </div>
  </div>
</div>

<!-- Inventar Popups -->
<div id="invActionPopup" class="popup-bg" aria-hidden="true">
  <div class="popup" role="dialog" aria-modal="true">
    <h3>Aktion w√§hlen</h3>
    <div style="display:flex;gap:8px;">
      <button id="invSellBtn">Verkaufen</button>
      <button id="invDiscardBtn">Wegwerfen</button>
      <button id="invCancelBtn">Abbrechen</button>
    </div>
  </div>
</div>

<div id="invSellPopup" class="popup-bg" aria-hidden="true">
  <div class="popup" role="dialog" aria-modal="true">
    <h3>Verkauf</h3>
    <label for="sellGold">Gold</label>
    <input id="sellGold" type="number" min="0" value="0">
    
    <label for="sellSilver">Silber</label>
    <input id="sellSilver" type="number" min="0" value="0">
    
    <label for="sellCopper">Kupfer</label>
    <input id="sellCopper" type="number" min="0" value="0">
    <label for="sellPin">PIN (vom DM)</label>
    <input id="sellPin" type="text" maxlength="4" value="">
    <div style="display:flex;gap:8px;margin-top:10px;">
      <button id="sellConfirmBtn">Verkaufen</button>
      <button id="sellCancelBtn">Abbrechen</button>
    </div>
  </div>
</div>

<!-- ============================
POPUP: Cloud-Laden (Name + Zuname)
============================ -->
<div id="uf-load-popup-bg" class="uf-popup-bg" style="display:none;">
  <div id="uf-load-popup" class="uf-popup">
    <h2 class="uf-popup-title">Charakter laden</h2>

    <label class="uf-label">Name:</label>
    <input id="uf-load-name" class="uf-input" type="text">

    <label class="uf-label">Zuname / Titel:</label>
    <input id="uf-load-title" class="uf-input" type="text">

    <div style="margin-top:12px; display:flex; justify-content:space-between;">
      <button id="uf-load-cancel" class="uf-btn">Abbrechen</button>
      <button id="uf-load-confirm" class="uf-btn">Laden</button>
    </div>
  </div>
</div>


<!-- ============================
UNDRA FOOTER (NEU)
============================ -->
<div id="undra-footer">

  <!-- LINKS: Charakter Laden -->
  <button id="uf-load" class="uf-btn">Charakter Laden</button>

  <!-- MITTE: SP & ATB -->
  <div id="uf-center">
    <div class="uf-value">
      <span class="uf-label">SP:</span>
      <span id="uf-sp-used">0</span> /
      <span id="uf-sp-left">0</span>
    </div>

    <div class="uf-value">
      <span class="uf-label">ATB:</span>
      <span id="uf-atb-used">0</span> /
      <span id="uf-atb-left">0</span>
    </div>
  </div>

  <!-- RECHTS: Speichern -->
  <button id="uf-save" class="uf-btn">Speichern</button>

</div>


<script>
    
/* ============================
TIMELINE
============================ */
function renderTimeline(S) {
  const top = document.getElementById("s3-timeline-top");
  const bottom = document.getElementById("s3-timeline-bottom");
  if (!top || !bottom) return;
  top.innerHTML = "";
  bottom.innerHTML = "";
  for (let i = 1; i <= 60; i++) {
    const d = document.createElement("div");
    d.className = "s3-day-btn";
    d.textContent = i;
    if (i === S.timeline.story.currentDay) d.classList.add("active");
    if (S.timeline.story.checked && S.timeline.story.checked.includes(i)) d.classList.add("checked");
    (i <= 30 ? top : bottom).appendChild(d);
  }
}

function checkOffTimelineDay(day) {
  if (!undra.state.timeline.story.checked) undra.state.timeline.story.checked = [];
  if (!undra.state.timeline.story.checked.includes(day)) undra.state.timeline.story.checked.push(day);
  renderTimeline(undra.state);
}
function activateNextDay(day) {
  undra.state.timeline.story.currentDay = Math.min(60, day + 1);
  renderTimeline(undra.state);
}

/* ============================
META + ATTR + VITALS + ARMOR + INVENTAR ‚Üí PAGE 3
============================ */
function undraApplyStateToPage3() {
  const S = undra.state;
  const setText = (id, txt) => { const el = document.getElementById(id); if (el) el.textContent = txt ?? ""; };

  // META
  setText("s3-name", S.meta.name);
  setText("s3-title", S.meta.title);
  setText("s3-race", S.meta.race);
  setText("s3-sub", S.meta.subrace);
  setText("s3-prof", S.meta.profession);
  setText("s3-spec", S.meta.special);

  const portrait = document.getElementById("s3-portrait-mirror");
  if (portrait) {
    portrait.innerHTML = S.meta.portrait
      ? `<img src="${S.meta.portrait}" style="width:100%;height:100%;object-fit:cover;">`
      : "";
  }

  // CURRENCY
  setText("s3-gold", S.currency.gold);
  setText("s3-silver", S.currency.silver);
  setText("s3-copper", S.currency.copper);

  // SP / DAY
  setText("s3-sp-total", S.day.totalSP);
  setText("s3-sp-hidden", S.day.hiddenSP);

  // ATTRIBUTES
  const attrGrid = document.getElementById("s3-attr-grid");
  if (attrGrid) {
    attrGrid.innerHTML = "";
    for (const key in S.attributes) {
      const row = document.createElement("div");
      row.className = "s3-attr-row";
      row.textContent = `${key}: ${S.attributes[key]}`;
      attrGrid.appendChild(row);
    }
  }

  // VITALS (nur Anzeige, Berechnung separat)
  const vitGrid = document.getElementById("s3-vital-grid");
  if (vitGrid) {
    vitGrid.innerHTML = "";
    for (const key in S.vitals) {
      const row = document.createElement("div");
      row.className = "s3-vital-row";
      row.textContent = `${key}: ${S.vitals[key]}`;
      vitGrid.appendChild(row);
    }
  }

  // ARMOR ZONES (Liste)
  const hitGrid = document.getElementById("s3-hitzones-grid");
  if (hitGrid) {
    hitGrid.innerHTML = "";
    for (let i = 1; i <= 8; i++) {
      const z = S.armor.zones[i] || { cur: 0, max: 0, type: null };
      const d = document.createElement("div");
      d.className = "s3-hitzone-cell";
      d.textContent = `Zone ${i}: ${z.cur}/${z.max}`;
      hitGrid.appendChild(d);
    }
  }

  // INVENTORY (nur Anzeige)
  const inv = document.getElementById("s3-inventory-grid");
  if (inv) {
    inv.innerHTML = "";
    const all = [...S.inventory.small, ...S.inventory.medium, ...S.inventory.large];
    all.forEach(item => {
      const slot = document.createElement("div");
      slot.className = "s3-inv-slot";
      slot.textContent = item || "-";
      inv.appendChild(slot);
    });
  }

  renderTimeline(S);
}

/* ============================
VITALS
============================ */
const magicalClasses = ["Feuermagier","Druide","Necromant","Hexer","Schamane","Illusionist","Alchemist","Kampfmagier","Drachendisciple"];
const paladinClass = "Paladin";

function getBonusType(profession) {
  if (profession === paladinClass) return "SGP";
  if (magicalClasses.includes(profession)) return "AS";
  return "AU";
}
function getSpCostForLevel(level) { return level * 1000; }
function getLinearBonus(level) { return level * 10; }
function getPercentBonus(level) { return level * 10; }

function ensureVitalBonusStructure(c) {
  if (!c.vitalBonus) c.vitalBonus = { LE:0, RUEST:0, DYN:0, GG:0, TC:0 };
}

function applyVitalBonusToVitals(base, c) {
  const vb = c.vitalBonus || {};
  const dynType = getBonusType(c.meta.profession);
  const r = { ...base };
  r.hp = (c.hp ?? r.hp) + getLinearBonus(vb.LE || 0);
  r.armorTotal += getLinearBonus(vb.RUEST || 0);
  if (dynType === "AU") r.stamina = (r.stamina || 0) + getLinearBonus(vb.DYN || 0);
  else if (dynType === "AS") r.ae = (r.ae || 0) + getLinearBonus(vb.DYN || 0);
  else r.sgp = (r.sgp || 0) + getLinearBonus(vb.DYN || 0);
  if ((vb.GG || 0) > 0) r.gg = Math.round(r.gg * (1 + getPercentBonus(vb.GG)/100));
  if ((vb.TC || 0) > 0) r.tc = Math.round(r.tc * (1 + getPercentBonus(vb.TC)/100));
  return r;
}

function calculateBaseVitals(attrs) {
  return { hp: 100, armorTotal: 10, stamina: 50, ae: 0, sgp: 20, gg: 100, tc: 10 };
}

function updateVitalsDisplayFromState() {
  const c = undra.state;
  const base = calculateBaseVitals(c.attributes);
  const final = applyVitalBonusToVitals(base, c);
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  set("vital-le", final.hp);
  set("vital-ruest", final.armorTotal);
  set("vital-gg", final.gg);
  set("vital-tc", final.tc);
  const dynType = getBonusType(c.meta.profession);
  set("vital-dyn-label", dynType === "AU" ? "Ausdauer" : dynType === "AS" ? "Astralenergie" : "Segenspunkte");
  set("vital-dyn", dynType === "AU" ? final.stamina : dynType === "AS" ? final.ae : final.sgp);
}

/* ============================
ARMOR
============================ */
const stageColors = { disabled: "#4b5563", full: "#e8d9f0", yellow: "#fbbf24", orange: "#f59e0b", red: "#ef4444" };

function getStageColorForZone(zoneObj) {
  const max = zoneObj?.max || 0;
  const cur = zoneObj?.cur || 0;
  if (!max) return stageColors.disabled;
  if (cur === max) return stageColors.full;
  const pct = (cur / max) * 100;
  if (pct >= 75) return stageColors.yellow;
  if (pct >= 50) return stageColors.orange;
  if (pct > 0) return stageColors.red;
  return stageColors.disabled;
}

function renderZonesFromState() {
  const zones = undra.state.armor.zones;
  for (let z = 1; z <= 8; z++) {
    const el = document.getElementById(`zone${z}`);
    if (!el) continue;
    const color = getStageColorForZone(zones[z] || {});
    try {
      el.setAttribute("fill", color);
      el.setAttribute("stroke", undra.state.armor.selected === z ? "#fff" : "#555");
    } catch(e){}
  }
  const listEl = document.getElementById("zoneList");
  if (listEl) {
    let html = `<p><b>Gold:</b> ${undra.state.currency.gold}</p>`;
    for (let z=1; z<=8; z++){
      const zone = undra.state.armor.zones[z] || {cur:0,max:0};
      const color = getStageColorForZone(zone);
      html += `<div class="zone-box"><b>${z}. Zone</b><span style="display:inline-block;width:10px;height:10px;background:${color};border-radius:2px;margin-left:4px;"></span><br>R√ºstung: ${zone.cur} / ${zone.max}</div>`;
    }
    listEl.innerHTML = html;
  }
}

/* ============================
INVENTORY ENGINE
============================ */
const DM_PIN_LIST = ["1023","3844","9281","5520","7712","4499","6601","8834","1209","3348","9921","4410","5582","7719","6623","1188","9033","2201","7744","6655","1102","9901","4488","5567","7723","6644","1199","9077","2233","7788","6677","1120","9944","4477","5599","7733","6688","1133","9002","2255","7799","6699","1144","9966","4490","5578","7711","6633","1166","9090","2288","7700","6600","1111","9999","4444","5555","7777","6666","2222"];

undra.engine = undra.engine || {};
undra.engine.inventory = {
  state: {
    items: {
      small: undra.state.inventory.small.slice(),
      medium: undra.state.inventory.medium.slice(),
      large: undra.state.inventory.large.slice()
    },
    dmCodes: DM_PIN_LIST.slice(),
    selected: null
  },
  _onUpdate: null,
  onUpdate(cb){ this._onUpdate = cb; },
  cleanItemText(text){ return (text||"").trim().replace(/\s{2,}/g," "); },
  validateItemText(text){
    if(!text) return true;
    if(/[,\/|;]/.test(text)) return false;
    if(/\s{3,}/.test(text)) return false;
    return true;
  },
  setItem(category,index,text){
    const cleaned = this.cleanItemText(text);
    if(!this.validateItemText(cleaned)){
      alert("Ung√ºltiger Eintrag. Ein Slot darf nur EIN Item enthalten.");
      return false;
    }
    this.state.items[category][index] = cleaned;
    this.syncToUndraState();
    if(this._onUpdate) this._onUpdate();
    return true;
  },
  removeItem(category,index){
    this.state.items[category][index] = "";
    this.syncToUndraState();
    if(this._onUpdate) this._onUpdate();
  },
  discardItem(category,index){
    this.removeItem(category,index);
  },
  sortCategory(category){
    const arr = this.state.items[category];
    const filled = arr.filter(x=>x.trim()!=="");
    const empty = arr.filter(x=>x.trim()==="");
    this.state.items[category] = [...filled,...empty];
    this.syncToUndraState();
    if(this._onUpdate) this._onUpdate();
  },
  validatePin(pin){ return this.state.dmCodes.includes(pin); },
  convertToCopper(g,s,c){ return (g*10000)+(s*100)+c; },
  sellItem(category,index,g,s,c,pin){
    if(!this.validatePin(pin)){ alert("PIN ung√ºltig."); return false; }
    const totalCopper = this.convertToCopper(g,s,c);
    undra.engine.currency.addCopper(totalCopper);
    this.removeItem(category,index);
    return true;
  },
  syncToUndraState(){
    undra.state.inventory.small = this.state.items.small.slice();
    undra.state.inventory.medium = this.state.items.medium.slice();
    undra.state.inventory.large = this.state.items.large.slice();
  },
  syncFromUndraState(){
    this.state.items.small = undra.state.inventory.small.slice();
    this.state.items.medium = undra.state.inventory.medium.slice();
    this.state.items.large = undra.state.inventory.large.slice();
  },
  init(){
    this.syncFromUndraState();
    if(this._onUpdate) this._onUpdate();
  }
};

/* ============================
CURRENCY ENGINE
============================ */
undra.engine.currency = {
  gold: undra.state.currency.gold || 0,
  silver: undra.state.currency.silver || 0,
  copper: undra.state.currency.copper || 0,
  set(g,s,c){
    this.gold=g||0; this.silver=s||0; this.copper=c||0;
    this.render();
  },
  addCopper(amount){
    let total = (this.gold*10000) + (this.silver*100) + this.copper + (amount||0);
    this.gold = Math.floor(total/10000);
    total %= 10000;
    this.silver = Math.floor(total/100);
    this.copper = total % 100;
    this.render();
    undra.state.currency.gold = this.gold;
    undra.state.currency.silver = this.silver;
    undra.state.currency.copper = this.copper;
  },
  render(){
    const g = document.getElementById("money-gold");
    const s = document.getElementById("money-silver");
    const c = document.getElementById("money-copper");
    if (g) g.textContent = this.gold;
    if (s) s.textContent = this.silver;
    if (c) c.textContent = this.copper;
  }
};

/* ============================
PAGE 3: STATE & DAY-END
============================ */
let s3_state = {
  totalSP: 0,
  hiddenSP: 0,
  gold: 0,
  silver: 0,
  copper: 0,
  currentDay: 1,
  dayFinalized: false,
  attributePoints: 0,
  skills: { base: [], race: [], prof: [] },
  vitals: {},
  combatStats: {}
};

function initStep3FromStep1() {
  undraSyncPage1();
  undraApplyStateToPage3();

  s3_state.totalSP    = undra.state.day.totalSP || 0;
  s3_state.hiddenSP   = undra.state.day.hiddenSP || 0;
  s3_state.currentDay = undra.state.timeline.story.currentDay || 1;
  s3_state.dayFinalized = undra.state.day.finalized || false;
  s3_state.gold   = undra.state.currency.gold || 0;
  s3_state.silver = undra.state.currency.silver || 0;
  s3_state.copper = undra.state.currency.copper || 0;

  updateS3SPAndCurrency();
  renderZonesFromState();
  undra.engine.inventory.init();
}

function updateS3SPAndCurrency() {
  const s = s3_state;
  const set = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
  set("s3-sp-total", s.totalSP);
  set("s3-sp-hidden", s.hiddenSP);
  set("s3-gold", s.gold);
  set("s3-silver", s.silver);
  set("s3-copper", s.copper);
}

const dayEndMessages = [
  "Danke, dass du heute wieder Teil von Avalon warst. Deine Reise pr√§gt die Welt.",
  "Ein weiterer Tag endet ‚Äì und du hast ihn mit Leben gef√ºllt. Danke f√ºr deine Zeit.",
  "Wir sch√§tzen deine Anwesenheit in UNDRA. Jeder Schritt, den du machst, hinterl√§sst Spuren."
];
function getRandomDayEndMessage(){ return dayEndMessages[Math.floor(Math.random()*dayEndMessages.length)]; }

function openDayEndPopup() {
  if (s3_state.dayFinalized) return;
  const dayBonus = Math.min(400 + 100 * s3_state.currentDay, 6000);
  s3_state.hiddenSP += dayBonus;
  const spThisDay = s3_state.hiddenSP;
  const goldGain = Math.floor(spThisDay / 100);
  const msgEl = document.getElementById("dayend-message");
  const spEl = document.getElementById("dayend-sp");
  const goldEl = document.getElementById("dayend-gold");
  if (msgEl) msgEl.textContent = getRandomDayEndMessage();
  if (spEl) spEl.textContent = spThisDay;
  if (goldEl) goldEl.textContent = goldGain;
  const modal = document.getElementById("dayend-modal");
  if (modal) modal.style.display = "flex";
}

function finalizeDayEnd() {
  if (s3_state.dayFinalized) return;
  const spThisDay = s3_state.hiddenSP;
  const goldGain = Math.floor(spThisDay / 100);
  s3_state.totalSP += spThisDay;
  s3_state.gold += goldGain;
  s3_state.hiddenSP = 0;
  s3_state.attributePoints = 1;
  s3_state.dayFinalized = true;

  undra.state.day.totalSP   = s3_state.totalSP;
  undra.state.day.hiddenSP  = s3_state.hiddenSP;
  undra.state.day.finalized = s3_state.dayFinalized;
  undra.state.currency.gold = s3_state.gold;

  updateS3SPAndCurrency();
  checkOffTimelineDay(s3_state.currentDay);
  activateNextDay(s3_state.currentDay);
  s3_state.currentDay++;
  renderTimeline(undra.state);

  const modal = document.getElementById("dayend-modal");
  if (modal) modal.style.display = "none";
}










/* ============================
TAP TIMELINE (optional)
============================ */
let TAP = 0;
function saveTimelineUI() {
  const boxes = document.querySelectorAll(".tap-box input[type='checkbox']");
  const state = [];
  boxes.forEach(box => state.push(box.checked ? 1 : 0));
  try {
    localStorage.setItem("UNDRA_TAP_STATE", JSON.stringify(state));
    localStorage.setItem("UNDRA_TAP_VALUE", TAP.toString());
  } catch(e){}
}
function loadTimelineUI() {
  try {
    const savedState = JSON.parse(localStorage.getItem("UNDRA_TAP_STATE") || "[]");
    const savedTAP = parseInt(localStorage.getItem("UNDRA_TAP_VALUE") || "0", 10) || 0;
    TAP = savedTAP;
    const boxes = document.querySelectorAll(".tap-box input[type='checkbox']");
    boxes.forEach((box, i) => { if (savedState[i] === 1) box.checked = true; });
  } catch(e){}
}
function updateTapProgress() {
  const boxes = document.querySelectorAll(".tap-box input[type='checkbox']");
  const total = boxes.length;
  let done = 0;
  boxes.forEach(b => { if (b.checked) done++; });
  const percent = total ? Math.round((done / total) * 100) : 0;
  const bar = document.getElementById("tap-progress-bar");
  const text = document.getElementById("tap-progress-text");
  if (bar) bar.style.width = percent + "%";
  if (text) text.textContent = percent + "%";
}

        window.undra = window.undra || {};

/* ============================
RENDER ALL ‚Äì ZENTRALE FUNKTION
============================ */
function renderAll() {
  try {
    undraApplyStateToPage3();
    updateVitalsDisplayFromState();
    renderZonesFromState();
    renderTimeline(undra.state);
    undra.engine.inventory.syncFromUndraState();
    undra.engine.inventory._onUpdate && undra.engine.inventory._onUpdate();
    undra.engine.currency.set(
      undra.state.currency.gold,
      undra.state.currency.silver,
      undra.state.currency.copper
    );
  } catch (e) {
    console.error("renderAll Fehler:", e);
  }
}

/* ============================
DOM READY
============================ */
document.addEventListener("DOMContentLoaded", () => {
  // Inventory UI
  try {
    const engine = undra.engine.inventory;
    const small = document.getElementById("inv-small");
    const medium = document.getElementById("inv-medium");
    const large = document.getElementById("inv-large");
    const actionPopup = document.getElementById("invActionPopup");
    const sellPopup = document.getElementById("invSellPopup");
    let selCat = null, selIndex = null;

    function renderColumn(container, category){
      if(!container) return;
      container.innerHTML = "";
      for(let i=0;i<10;i++){
        const row = document.createElement("div");
        row.className="inv-row";
        const input = document.createElement("input");
        input.value = engine.state.items[category][i]||"";
        input.style.flex="1";
        input.addEventListener("change", ()=> engine.setItem(category,i,input.value));
        input.addEventListener("dragstart", e=> e.dataTransfer.setData("text/plain", JSON.stringify({category,index:i})));
        input.addEventListener("dragover", e=> e.preventDefault());
        input.addEventListener("drop", e=>{
          e.preventDefault();
          try{
            const data = JSON.parse(e.dataTransfer.getData("text/plain"));
            const srcCat = data.category, srcIndex = data.index;
            const temp = engine.state.items[srcCat][srcIndex];
            engine.state.items[srcCat][srcIndex] = engine.state.items[category][i];
            engine.state.items[category][i] = temp;
            engine.syncToUndraState();
            if(engine._onUpdate) engine._onUpdate();
          }catch(err){}
        });
        const btn = document.createElement("div");
        btn.className="inv-action";
        btn.style.width="28px";
        btn.style.height="28px";
        btn.style.cursor="pointer";
        btn.addEventListener("click", ()=>{
          selCat = category;
          selIndex = i;
          if(actionPopup) actionPopup.style.display="flex";
        });
        row.appendChild(input);
        row.appendChild(btn);
        container.appendChild(row);
      }
    }

    
    
    
    
    engine.onUpdate(()=> {
      renderColumn(small,"small");
      renderColumn(medium,"medium");
      renderColumn(large,"large");
    });
    engine.init();

    const sortSmallBtn = document.getElementById("sort-small");
    const sortMediumBtn = document.getElementById("sort-medium");
    const sortLargeBtn = document.getElementById("sort-large");
    if (sortSmallBtn) sortSmallBtn.addEventListener("click", ()=> engine.sortCategory("small"));
    if (sortMediumBtn) sortMediumBtn.addEventListener("click", ()=> engine.sortCategory("medium"));
    if (sortLargeBtn) sortLargeBtn.addEventListener("click", ()=> engine.sortCategory("large"));

    if(document.getElementById("invCancelBtn")) document.getElementById("invCancelBtn").addEventListener("click", ()=> { if(actionPopup) actionPopup.style.display="none"; });
    if(document.getElementById("invSellBtn")) document.getElementById("invSellBtn").addEventListener("click", ()=> { if(actionPopup) actionPopup.style.display="none"; if(sellPopup) sellPopup.style.display="flex"; });
    if(document.getElementById("invDiscardBtn")) document.getElementById("invDiscardBtn").addEventListener("click", ()=> {
      if(selCat!==null && selIndex!==null) engine.discardItem(selCat,selIndex);
      if(actionPopup) actionPopup.style.display="none";
    });

    if(document.getElementById("sellCancelBtn")) document.getElementById("sellCancelBtn").addEventListener("click", ()=> { if(sellPopup) sellPopup.style.display="none"; });
    if(document.getElementById("sellConfirmBtn")) document.getElementById("sellConfirmBtn").addEventListener("click", ()=>{
      const g = parseInt(document.getElementById("sellGold").value)||0;
      const s = parseInt(document.getElementById("sellSilver").value)||0;
      const c = parseInt(document.getElementById("sellCopper").value)||0;
      const pin = document.getElementById("sellPin").value||"";
      engine.sellItem(selCat,selIndex,g,s,c,pin);
      if(sellPopup) sellPopup.style.display="none";
    });
  } catch(e){
    console.warn("Inventory UI init skipped:", e);
  }

  // TAP timeline UI
  try {
    const row1 = document.getElementById("tap-row-1");
    const row2 = document.getElementById("tap-row-2");
    if (row1 && row2) {
      for (let i = 1; i <= 60; i++) {
        const box = document.createElement("div");
        box.className = "tap-box";
        box.style.display = "flex";
        box.style.alignItems = "center";
        box.style.gap = "8px";
        const checkbox = document.createElement("input");
        checkbox.type = "checkbox";
        checkbox.dataset.day = i;
        const label = document.createElement("label");
        label.textContent = "Tag " + i;
        box.appendChild(checkbox);
        box.appendChild(label);
        (i <= 30 ? row1 : row2).appendChild(box);
        checkbox.addEventListener("change", () => { saveTimelineUI(); updateTapProgress(); });
      }
    }
    loadTimelineUI();
    updateTapProgress();
  } catch(e){}

  // Armor zone click wiring
  try {
    document.querySelectorAll("#zoneSelectGrid div").forEach(el=>{
      el.addEventListener("click", ()=>{
        const v = parseInt(el.getAttribute("data-value"));
        if(!isNaN(v)){
          undra.state.armor.selected = v;
          renderZonesFromState();
        }
      });
    });
    for(let z=1; z<=8; z++){
      const el = document.getElementById(`zone${z}`);
      if(el) el.addEventListener("click", ()=>{
        undra.state.armor.selected = z;
        renderZonesFromState();
      });
    }
  } catch(e){}

 
});










/* ============================
CLOUD SAVE / LOAD
============================ */
async function savePage3ToCloud() {
  const id = `undra_${(undra.state.meta.name || "namenlos")
    .trim().toLowerCase()}_${(undra.state.meta.title || "ohne")
    .trim().toLowerCase()}`.replace(/\s+/g, "_");

  try {
    const res = await fetch(`https://undra.djdrear.workers.dev/save/${id}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(undra.state)
    });

    if (!res.ok) {
      alert("Fehler beim Cloud‚ÄëSpeichern.");
      console.error(await res.text());
      return;
    }

    alert("Charakter erfolgreich gespeichert.");
  } catch (err) {
    console.error(err);
    alert("Netzwerkfehler beim Cloud‚ÄëSpeichern.");
  }
}

async function loadPage3FromCloud(name, title) {
  const id = `undra_${(name || "namenlos")
    .trim().toLowerCase()}_${(title || "ohne")
    .trim().toLowerCase()}`.replace(/\s+/g, "_");

  try {
    const res = await fetch(`https://undra.djdrear.workers.dev/load/${id}`);

    if (!res.ok) {
      alert("Charakter nicht gefunden.");
      console.error(await res.text());
      return;
    }

    const data = await res.json();

    if (!data || typeof data !== "object" || !data.meta || !data.meta.name) {
      alert("Ung√ºltige Cloud‚ÄëDaten.");
      console.error("Geladene Daten:", data);
      return;
    }

    undra.state = JSON.parse(JSON.stringify(data));
    renderAll();

    alert(`Charakter "${undra.state.meta.name}" geladen.`);
  } catch (err) {
    console.error(err);
    alert("Fehler beim Cloud‚ÄëLaden.");
  }
}

/* ============================
FOOTER BUTTONS & POPUP
============================ */
document.getElementById("uf-load").addEventListener("click", () => {
  document.getElementById("uf-load-popup-bg").style.display = "flex";
});

document.getElementById("uf-load-cancel").addEventListener("click", () => {
  document.getElementById("uf-load-popup-bg").style.display = "none";
});

document.getElementById("uf-load-confirm").addEventListener("click", () => {
  const name  = document.getElementById("uf-load-name").value.trim();
  const title = document.getElementById("uf-load-title").value.trim();

  if (!name) {
    alert("Bitte einen Namen eingeben.");
    return;
  }

  document.getElementById("uf-load-popup-bg").style.display = "none";
  loadPage3FromCloud(name, title);
});

document.getElementById("uf-save").addEventListener("click", () => {
  savePage3ToCloud();
});

/* ============================
EXPOSE (optional)
============================ */
window.undraApplyStateToPage3 = undraApplyStateToPage3;
window.undraUpdateVitals = updateVitalsDisplayFromState;
window.undraRenderZones = renderZonesFromState;
window.undraRenderAll = renderAll;

</script>
</body>
</html>
